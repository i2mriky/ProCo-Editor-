<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProEdit Mobile V5</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror & Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/neo.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-palenight.min.css">
    
    <!-- CodeMirror Core JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* CodeMirror Customization */
        .CodeMirror {
            height: 100%;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Search Highlights */
        .cm-search-match {
            background-color: rgba(255, 255, 0, 0.4); /* Light Yellow */
        }
        .cm-search-match-active {
            background-color: rgba(255, 165, 0, 0.8); /* Orange */
            border-bottom: 2px solid #ff4500;
        }
        .dark .cm-search-match {
            background-color: rgba(255, 255, 0, 0.3);
        }
        .dark .cm-search-match-active {
            background-color: rgba(255, 140, 0, 0.7);
        }

        /* Symbol Toolbar */
        .symbol-toolbar {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .symbol-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            margin-right: 4px;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            font-weight: bold;
            font-family: monospace;
            font-size: 16px;
        }
        .dark .symbol-btn { background: rgba(255,255,255,0.1); color: #fff; }
        .symbol-btn:active { transform: scale(0.95); background: rgba(59, 130, 246, 0.2); }

        /* Transitions */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .view-section.active {
            display: flex;
            opacity: 1;
        }

        /* Structure Navigation Panel */
        .structure-panel {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        .structure-panel.open {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 h-screen w-screen overflow-hidden flex flex-col">

    <!-- ================= DASHBOARD VIEW ================= -->
    <div id="dashboardView" class="view-section active flex-col h-full absolute inset-0 z-10 bg-gray-50 dark:bg-gray-900 overflow-y-auto">
        <header class="px-6 py-6 bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-20">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-blue-600 dark:text-blue-400">ProEdit <span class="text-xs align-top text-gray-400">v5</span></h1>
                    <p class="text-xs text-gray-500">Professional Mobile IDE</p>
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i data-lucide="moon" id="dashThemeIcon" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="createNewFilePrompt()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl flex flex-col items-center justify-center font-semibold shadow-lg shadow-blue-500/20 transition-all active:scale-95">
                    <i data-lucide="plus-circle" class="w-6 h-6 mb-1"></i> 
                    <span>New Project</span>
                </button>
                <label class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-white p-4 rounded-xl flex flex-col items-center justify-center font-semibold cursor-pointer transition-all active:scale-95 shadow-sm">
                    <i data-lucide="folder-open" class="w-6 h-6 mb-1 text-yellow-500"></i>
                    <span>Open File</span>
                    <input type="file" id="fileInput" class="hidden" onchange="importFile(this)">
                </label>
            </div>
        </header>

        <main class="flex-1 p-6 pb-20">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Workspace</h2>
                <span id="fileCount" class="text-xs text-gray-400 bg-gray-200 dark:bg-gray-800 px-2 py-1 rounded-full">0 files</span>
            </div>
            
            <div id="fileList" class="grid grid-cols-1 gap-3">
                <!-- File Cards -->
            </div>
            
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-gray-400">
                <i data-lucide="coffee" class="w-12 h-12 mb-3 opacity-30"></i>
                <p class="text-sm">No active projects.</p>
            </div>
        </main>
    </div>

    <!-- ================= EDITOR VIEW ================= -->
    <div id="editorView" class="view-section flex-col h-full absolute inset-0 z-20 bg-white dark:bg-gray-900">
        <!-- Editor Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-2 py-2 flex items-center justify-between shadow-sm shrink-0 z-30">
            <div class="flex items-center min-w-0">
                <button onclick="saveAndGoHome()" class="p-2 mr-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full text-gray-500">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <div class="flex flex-col min-w-0">
                    <input type="text" id="fileNameInput" class="bg-transparent font-bold text-gray-800 dark:text-gray-100 focus:outline-none text-sm w-28 sm:w-32 truncate" value="script.js" onchange="updateCurrentFileName(this.value)">
                </div>
            </div>

            <!-- Toolbar Actions -->
            <div class="flex items-center space-x-0.5 sm:space-x-1">
                <!-- Download Button (Inside Editor) -->
                <button onclick="downloadCurrentFile()" class="p-2 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="Download">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>

                <!-- Structure Navigator (NEW) -->
                <button onclick="toggleStructureView()" class="p-2 text-gray-500 hover:text-purple-600 dark:hover:text-purple-400" title="Code Structure">
                    <i data-lucide="list-tree" class="w-4 h-4"></i>
                </button>

                <!-- Search -->
                <button onclick="toggleSearch()" class="p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                    <i data-lucide="search" class="w-4 h-4"></i>
                </button>

                <!-- Undo/Redo -->
                <button onclick="editor.undo()" class="p-2 text-gray-500 hidden sm:block hover:text-gray-800 dark:hover:text-white" title="Undo">
                    <i data-lucide="undo-2" class="w-4 h-4"></i>
                </button>

                <!-- Run -->
                <button onclick="runCode()" class="ml-1 px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-xs flex items-center shadow-md active:scale-95 transition-transform">
                    <i data-lucide="play" class="w-3 h-3 mr-1"></i> RUN
                </button>
            </div>
        </header>

        <!-- Advanced Search Panel -->
        <div id="searchBar" class="hidden bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-2 animate-in slide-in-from-top duration-200 shrink-0">
            <div class="flex flex-col space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="w-3 h-3 absolute left-3 top-2.5 text-gray-500 dark:text-gray-400"></i>
                        <!-- FIX: Added 'text-gray-900 dark:text-white' to ensure visibility in dark mode -->
                        <input type="text" id="searchInput" placeholder="Find in file..." class="w-full pl-8 pr-2 py-1.5 text-sm rounded-lg border bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="liveSearch()">
                    </div>
                    <div class="flex items-center bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 overflow-hidden">
                        <button onclick="navigateMatch(-1)" class="px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-600 border-r border-gray-300 dark:border-gray-600">
                            <i data-lucide="chevron-up" class="w-4 h-4 text-gray-600 dark:text-white"></i>
                        </button>
                        <button onclick="navigateMatch(1)" class="px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-600 dark:text-white"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span id="searchCount" class="text-xs text-gray-500 dark:text-gray-400 font-mono ml-1">No results</span>
                    <button onclick="document.getElementById('replaceRow').classList.toggle('hidden')" class="text-xs text-blue-500 font-medium">Toggle Replace</button>
                </div>
                <div id="replaceRow" class="hidden flex space-x-2 pt-1 border-t border-gray-200 dark:border-gray-700">
                    <!-- FIX: Added 'text-gray-900 dark:text-white' here too -->
                    <input type="text" id="replaceInput" placeholder="Replace with..." class="flex-1 px-3 py-1.5 text-sm rounded-lg border bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                    <button onclick="replaceCurrent()" class="px-3 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-lg text-xs font-bold">One</button>
                    <button onclick="replaceAll()" class="px-3 py-1 bg-blue-600 text-white rounded-lg text-xs font-bold">All</button>
                </div>
            </div>
        </div>

        <!-- CodeMirror Area -->
        <main class="flex-1 relative overflow-hidden bg-white dark:bg-gray-900">
            <textarea id="codeEditor"></textarea>

            <!-- Structure Navigation Modal (Overlay) -->
            <div id="structureOverlay" class="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm hidden flex flex-col justify-end" onclick="toggleStructureView(false)">
                <div class="structure-panel bg-white dark:bg-gray-800 w-full max-h-[70%] rounded-t-2xl shadow-2xl flex flex-col" onclick="event.stopPropagation()">
                    <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200 flex items-center">
                            <i data-lucide="compass" class="w-4 h-4 mr-2 text-purple-500"></i> Navigator
                        </h3>
                        <button onclick="toggleStructureView(false)" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-white"></i>
                        </button>
                    </div>
                    
                    <div class="p-3 border-b border-gray-100 dark:border-gray-700">
                        <input type="text" id="structureSearch" placeholder="Filter sections or functions..." 
                               class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-900 border-none rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-500"
                               oninput="filterStructure()">
                    </div>

                    <div id="structureList" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <!-- Items injected via JS -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Quick Symbol Toolbar -->
        <div class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-1 shrink-0 z-30">
            <div class="symbol-toolbar flex px-1 py-1" id="symbolToolbar">
                <!-- Symbols injected via JS -->
            </div>
        </div>
    </div>

    <!-- ================= PREVIEW VIEW ================= -->
    <div id="previewView" class="view-section flex-col h-full absolute inset-0 z-40 bg-white dark:bg-gray-900 translate-x-full transition-transform duration-300">
        <div class="bg-gray-900 text-white px-4 py-3 flex items-center justify-between shadow-lg shrink-0">
            <button onclick="closePreview()" class="flex items-center text-gray-300 hover:text-white">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                <span class="font-medium">Edit Code</span>
            </button>
            <div class="flex items-center space-x-3">
                 <span class="text-xs font-mono bg-black/30 px-2 py-1 rounded text-green-400">‚óè Live</span>
                <button onclick="downloadCurrentFile()" class="bg-white/10 p-1.5 rounded hover:bg-white/20">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>
                <button onclick="runCode()" class="bg-white/10 p-1.5 rounded hover:bg-white/20">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <div class="flex-1 relative bg-white w-full">
            <iframe id="previewFrame" class="w-full h-full border-none block"></iframe>
        </div>
    </div>

    <script>
        // --- Initialization ---
        lucide.createIcons();
        const symbols = ['<', '>', '{', '}', '(', ')', '[', ']', '=', ';', ':', '"', "'", '!', '$', '&', '/', 'var', 'let', 'func'];
        
        let files = JSON.parse(localStorage.getItem('proedit_files') || '[]');
        let currentFileId = null;
        let editor = null;
        let darkMode = false;

        // Search State
        let searchState = {
            query: '',
            matches: [], // Array of {from, to}
            currentIndex: -1,
            marks: [] // CodeMirror marks
        };

        // Init Editor
        const textarea = document.getElementById('codeEditor');
        editor = CodeMirror.fromTextArea(textarea, {
            mode: 'htmlmixed',
            lineNumbers: true,
            theme: 'neo',
            lineWrapping: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            styleActiveLine: true,
            tabSize: 4,
            indentUnit: 4,
            viewportMargin: Infinity
        });

        // --- EXPORT / DOWNLOAD FEATURE ---

        function downloadContent(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadCurrentFile() {
            if (currentFileId) {
                const file = files.find(f => f.id === currentFileId);
                if (file) {
                    // Always use current editor content if we are editing
                    const content = editor.getValue(); 
                    downloadContent(file.name, content);
                }
            }
        }

        function downloadFileFromList(id, event) {
            event.stopPropagation();
            const file = files.find(f => f.id === id);
            if (file) {
                downloadContent(file.name, file.content);
            }
        }

        // --- STRUCTURE NAVIGATOR (ADVANCED SEARCH) ---

        let structureItems = [];

        function toggleStructureView(forceState) {
            const overlay = document.getElementById('structureOverlay');
            const panel = overlay.querySelector('.structure-panel');
            
            const isOpen = !overlay.classList.contains('hidden');
            const shouldOpen = forceState !== undefined ? forceState : !isOpen;

            if (shouldOpen) {
                overlay.classList.remove('hidden');
                setTimeout(() => panel.classList.add('open'), 10);
                parseCodeStructure();
                document.getElementById('structureSearch').value = '';
                document.getElementById('structureSearch').focus();
            } else {
                panel.classList.remove('open');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function parseCodeStructure() {
            const code = editor.getValue();
            const listEl = document.getElementById('structureList');
            listEl.innerHTML = '';
            structureItems = [];

            const lines = code.split('\n');
            
            // Regex for various things
            // 1. Comments behaving as Sections: // --- Title --- or /* Title */
            const sectionRegex = /(\/\/|\/\*)\s*-*\s*([A-Za-z0-9\s_]+?)\s*-*(\*\/|$)/;
            
            // 2. Functions: function name(), const name = () =>
            const funcRegex = /function\s+([a-zA-Z0-9_]+)/;
            const arrowFuncRegex = /(const|let|var)\s+([a-zA-Z0-9_]+)\s*=\s*(\(|async)/;
            
            // 3. Classes
            const classRegex = /class\s+([a-zA-Z0-9_]+)/;

            // 4. HTML IDs (for HTML files)
            const htmlIdRegex = /id=["']([a-zA-Z0-9_-]+)["']/;

            lines.forEach((line, index) => {
                let type = null;
                let name = null;

                // Check for Section Comments (Highest Priority)
                const secMatch = line.match(sectionRegex);
                if (secMatch && line.length < 80) { // Limit length to avoid matching long paragraphs
                     // Ensure it looks like a header (optional check)
                     if(line.includes('---') || line.includes('===')) {
                        type = 'section';
                        name = secMatch[2].trim();
                     }
                }

                if (!type) {
                    const fnMatch = line.match(funcRegex);
                    if (fnMatch) { type = 'function'; name = fnMatch[1]; }
                }
                
                if (!type) {
                    const arrMatch = line.match(arrowFuncRegex);
                    if (arrMatch) { type = 'function'; name = arrMatch[2]; }
                }

                if (!type) {
                    const clsMatch = line.match(classRegex);
                    if (clsMatch) { type = 'class'; name = clsMatch[1]; }
                }

                if (!type && editor.getOption('mode') === 'htmlmixed') {
                    const idMatch = line.match(htmlIdRegex);
                    if (idMatch) { type = 'html-id'; name = '#' + idMatch[1]; }
                }

                if (type && name) {
                    structureItems.push({ type, name, line: index });
                }
            });

            renderStructureList(structureItems);
        }

        function renderStructureList(items) {
            const listEl = document.getElementById('structureList');
            listEl.innerHTML = '';

            if (items.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">No structure found.<br>Use // --- Title --- for sections.</div>';
                return;
            }

            items.forEach(item => {
                const el = document.createElement('div');
                
                // Styling based on type
                let icon = '';
                let classes = 'flex items-center p-2 rounded cursor-pointer transition-colors text-sm ';
                
                if (item.type === 'section') {
                    classes += 'bg-gray-100 dark:bg-gray-700 font-bold text-gray-800 dark:text-gray-100 mt-2';
                    icon = '<i data-lucide="heading" class="w-4 h-4 mr-2 text-blue-500"></i>';
                } else if (item.type === 'function') {
                    classes += 'hover:bg-gray-50 dark:hover:bg-gray-700/50 text-gray-600 dark:text-gray-300 ml-2';
                    icon = '<i data-lucide="braces" class="w-3 h-3 mr-2 text-purple-500"></i>';
                } else if (item.type === 'class') {
                    classes += 'hover:bg-gray-50 dark:hover:bg-gray-700/50 font-semibold text-yellow-600 dark:text-yellow-400';
                    icon = '<i data-lucide="box" class="w-3 h-3 mr-2"></i>';
                } else {
                    classes += 'hover:bg-gray-50 dark:hover:bg-gray-700/50 text-gray-500 ml-2';
                    icon = '<i data-lucide="hash" class="w-3 h-3 mr-2 text-green-500"></i>';
                }

                el.className = classes;
                el.innerHTML = `${icon}<span>${item.name}</span>`;
                el.onclick = () => jumpToLine(item.line);
                listEl.appendChild(el);
            });
            lucide.createIcons();
        }

        function filterStructure() {
            const query = document.getElementById('structureSearch').value.toLowerCase();
            const filtered = structureItems.filter(item => item.name.toLowerCase().includes(query));
            renderStructureList(filtered);
        }

        function jumpToLine(lineIdx) {
            toggleStructureView(false);
            editor.setCursor({ line: lineIdx, ch: 0 });
            editor.scrollIntoView({ line: lineIdx, ch: 0 }, 100);
            editor.focus();
            
            // Highlight momentarily
            const mark = editor.markText(
                { line: lineIdx, ch: 0 }, 
                { line: lineIdx + 1, ch: 0 }, 
                { className: "cm-search-match-active" }
            );
            setTimeout(() => mark.clear(), 1500);
        }

        // --- SEARCH SYSTEM (Existing) ---

        function toggleSearch() {
            const bar = document.getElementById('searchBar');
            bar.classList.toggle('hidden');
            if(!bar.classList.contains('hidden')) {
                document.getElementById('searchInput').focus();
                liveSearch();
            } else {
                clearSearch();
                editor.focus();
            }
        }

        function clearSearch() {
            searchState.marks.forEach(m => m.clear());
            searchState.matches = [];
            searchState.currentIndex = -1;
            searchState.query = '';
            document.getElementById('searchCount').innerText = "No results";
        }

        function liveSearch() {
            const query = document.getElementById('searchInput').value;
            if (query === searchState.query && searchState.matches.length > 0) return;
            
            clearSearch();
            searchState.query = query;
            
            if (!query) return;

            const cursor = editor.getSearchCursor(query);
            while (cursor.findNext()) {
                const from = cursor.from();
                const to = cursor.to();
                searchState.matches.push({ from, to });
                searchState.marks.push(editor.markText(from, to, { className: "cm-search-match" }));
            }

            if (searchState.matches.length > 0) {
                const docCursor = editor.getCursor();
                let nextIdx = searchState.matches.findIndex(m => m.from.line >= docCursor.line && m.from.ch >= docCursor.ch);
                if (nextIdx === -1) nextIdx = 0;
                
                searchState.currentIndex = nextIdx;
                highlightActiveMatch();
            }
            updateSearchUI();
        }

        function navigateMatch(direction) {
            if (searchState.matches.length === 0) return;
            searchState.currentIndex += direction;
            if (searchState.currentIndex >= searchState.matches.length) searchState.currentIndex = 0;
            if (searchState.currentIndex < 0) searchState.currentIndex = searchState.matches.length - 1;
            highlightActiveMatch();
            updateSearchUI();
        }

        function highlightActiveMatch() {
            const match = searchState.matches[searchState.currentIndex];
            editor.setSelection(match.from, match.to);
            editor.scrollIntoView({from: match.from, to: match.to}, 50);
        }

        function updateSearchUI() {
            const countEl = document.getElementById('searchCount');
            if (searchState.matches.length === 0) {
                countEl.innerText = "No results";
            } else {
                countEl.innerText = `${searchState.currentIndex + 1} of ${searchState.matches.length}`;
            }
        }

        function replaceCurrent() {
            if (searchState.matches.length === 0) return;
            const replacement = document.getElementById('replaceInput').value;
            editor.replaceSelection(replacement);
            liveSearch();
        }

        function replaceAll() {
            const query = document.getElementById('searchInput').value;
            const replacement = document.getElementById('replaceInput').value;
            if (!query) return;
            editor.operation(() => {
                const cursor = editor.getSearchCursor(query);
                while (cursor.findNext()) {
                    cursor.replace(replacement);
                }
            });
            liveSearch();
        }

        // --- Toolbar & Init Logic ---

        const toolbar = document.getElementById('symbolToolbar');
        
        // Add Tab Key
        const tabBtn = document.createElement('button');
        tabBtn.className = 'symbol-btn';
        tabBtn.innerHTML = '<i data-lucide="arrow-right-to-line" class="w-4 h-4"></i>';
        tabBtn.onclick = (e) => { e.preventDefault(); editor.replaceSelection("    "); editor.focus(); };
        toolbar.appendChild(tabBtn);

        symbols.forEach(sym => {
            const btn = document.createElement('button');
            btn.className = 'symbol-btn';
            btn.textContent = sym;
            btn.onclick = (e) => { e.preventDefault(); editor.replaceSelection(sym); editor.focus(); };
            toolbar.appendChild(btn);
        });

        // Auto-save
        editor.on('change', () => {
            if (currentFileId) {
                const fileIndex = files.findIndex(f => f.id === currentFileId);
                if (fileIndex !== -1) {
                    files[fileIndex].content = editor.getValue();
                    files[fileIndex].lastModified = Date.now();
                    saveToStorage();
                }
            }
        });

        // --- Standard Functions ---

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                if(el.id === 'previewView') el.classList.remove('translate-x-0');
                if(el.id === 'previewView') el.classList.add('translate-x-full');
            });
            if (viewId === 'previewView') {
                document.getElementById('editorView').classList.add('active');
                const pv = document.getElementById('previewView');
                pv.classList.add('active');
                requestAnimationFrame(() => {
                    pv.classList.remove('translate-x-full');
                    pv.classList.add('translate-x-0');
                });
            } else {
                document.getElementById(viewId).classList.add('active');
            }
        }

        function saveAndGoHome() {
            saveToStorage();
            renderFileList();
            switchView('dashboardView');
            currentFileId = null;
        }

        function saveToStorage() {
            localStorage.setItem('proedit_files', JSON.stringify(files));
            updateFileCount();
        }

        function createNewFilePrompt() {
            const name = prompt("Filename:", "index.html");
            if (name) {
                const newFile = {
                    id: Date.now().toString(),
                    name: name,
                    content: getTemplate(name),
                    mode: getModeFromExt(name),
                    lastModified: Date.now()
                };
                files.unshift(newFile);
                saveToStorage();
                openFile(newFile.id);
            }
        }

        function getTemplate(filename) {
            if (filename.endsWith('.js')) return `// --- SETUP ---\n\n// Welcome to ${filename}\nconsole.log("Hello!");\n\n// --- FUNCTIONS ---\n\nfunction init() {\n    // Code here\n}`;
            if (filename.endsWith('.css')) return `/* --- STYLES --- */\n\nbody {\n    background: #f0f0f0;\n}`;
            if (filename.endsWith('.html')) return `<!DOCTYPE html>\n<html>\n<!-- --- HEAD --- -->\n<head>\n    <title>New Page</title>\n</head>\n<body>\n    <!-- --- CONTENT --- -->\n    <h1 id="mainTitle">Hello World</h1>\n</body>\n</html>`;
            return '';
        }

        function getModeFromExt(filename) {
            if (filename.endsWith('.js')) return 'javascript';
            if (filename.endsWith('.css')) return 'css';
            return 'htmlmixed';
        }

        function importFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: e.target.result,
                    mode: getModeFromExt(file.name),
                    lastModified: Date.now()
                };
                files.unshift(newFile);
                saveToStorage();
                openFile(newFile.id);
                input.value = '';
            };
            reader.readAsText(file);
        }

        function openFile(id) {
            const file = files.find(f => f.id === id);
            if (!file) return;
            currentFileId = id;
            document.getElementById('fileNameInput').value = file.name;
            editor.setOption('mode', file.mode);
            editor.setValue(file.content);
            editor.clearHistory();
            switchView('editorView');
            setTimeout(() => editor.refresh(), 100);
        }

        function deleteFile(id, e) {
            e.stopPropagation();
            if(confirm("Delete this file?")) {
                files = files.filter(f => f.id !== id);
                saveToStorage();
                renderFileList();
            }
        }

        function updateCurrentFileName(newName) {
            if (currentFileId) {
                const file = files.find(f => f.id === currentFileId);
                file.name = newName;
                file.mode = getModeFromExt(newName);
                editor.setOption('mode', file.mode);
                saveToStorage();
            }
        }

        function updateFileCount() {
            document.getElementById('fileCount').textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
        }

        function renderFileList() {
            const list = document.getElementById('fileList');
            const empty = document.getElementById('emptyState');
            list.innerHTML = '';

            if (files.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                files.forEach(file => {
                    const date = new Date(file.lastModified).toLocaleDateString();
                    let iconName = 'file-code';
                    let color = 'text-blue-500';
                    if(file.name.endsWith('.js')) { iconName = 'file-json'; color = 'text-yellow-500'; }
                    if(file.name.endsWith('.css')) { iconName = 'palette'; color = 'text-pink-500'; }

                    const card = document.createElement('div');
                    card.className = "flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm active:scale-[0.98] transition-transform cursor-pointer";
                    card.onclick = () => openFile(file.id);
                    
                    card.innerHTML = `
                        <div class="flex items-center space-x-4 min-w-0">
                            <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shrink-0">
                                <i data-lucide="${iconName}" class="w-6 h-6 ${color}"></i>
                            </div>
                            <div class="min-w-0">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-sm truncate w-32 sm:w-48">${file.name}</h3>
                                <p class="text-xs text-gray-400">Modified: ${date}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button onclick="downloadFileFromList('${file.id}', event)" class="p-2 text-gray-400 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-lucide="download" class="w-5 h-5"></i>
                            </button>
                            <button onclick="deleteFile('${file.id}', event)" class="p-2 text-gray-400 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(card);
                });
                lucide.createIcons();
            }
            updateFileCount();
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark');
            editor.setOption('theme', darkMode ? 'material-palenight' : 'neo');
            document.getElementById('dashThemeIcon').setAttribute('data-lucide', darkMode ? 'sun' : 'moon');
            lucide.createIcons();
        }

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleTheme();

        function runCode() {
            const content = editor.getValue();
            const frame = document.getElementById('previewFrame');
            const doc = frame.contentWindow.document;

            switchView('previewView');

            let codeToRun = content;
            if (editor.getOption('mode') === 'javascript') {
                codeToRun = `
                <!DOCTYPE html>
                <html>
                <body style="font-family: monospace; padding: 20px; background: #1e1e1e; color: #fff;">
                    <div style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; color: #888;">CONSOLE OUTPUT</div>
                    <div id="logs"></div>
                    <script>
                        const log = console.log;
                        const output = document.getElementById('logs');
                        console.log = function(...args) {
                            args.forEach(arg => {
                                const d = document.createElement('div');
                                d.textContent = "> " + (typeof arg === 'object' ? JSON.stringify(arg) : arg);
                                d.style.padding = "4px 0";
                                d.style.borderBottom = "1px solid #333";
                                output.appendChild(d);
                            });
                            log.apply(console, args);
                        };
                        try { ${content} } catch(e) { console.log("Error: " + e.message); }
                    <\/script>
                </body>
                </html>`;
            }
            doc.open();
            doc.write(codeToRun);
            doc.close();
        }
        
        function closePreview() {
            document.getElementById('previewView').classList.remove('translate-x-0');
            document.getElementById('previewView').classList.add('translate-x-full');
            setTimeout(() => document.getElementById('previewView').classList.remove('active'), 300);
        }

        renderFileList();
    </script>
</body>
</html>

