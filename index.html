<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProEdit Mobile V4</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror & Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/neo.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-palenight.min.css">
    
    <!-- CodeMirror Core JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* CodeMirror Customization */
        .CodeMirror {
            height: 100%;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Search Highlights */
        .cm-search-match {
            background-color: rgba(255, 255, 0, 0.4); /* Light Yellow */
        }
        .cm-search-match-active {
            background-color: rgba(255, 165, 0, 0.8); /* Orange */
            border-bottom: 2px solid #ff4500;
        }
        .dark .cm-search-match {
            background-color: rgba(255, 255, 0, 0.3);
        }
        .dark .cm-search-match-active {
            background-color: rgba(255, 140, 0, 0.7);
        }

        /* Symbol Toolbar */
        .symbol-toolbar {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .symbol-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            margin-right: 4px;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            font-weight: bold;
            font-family: monospace;
            font-size: 16px;
        }
        .dark .symbol-btn { background: rgba(255,255,255,0.1); color: #fff; }
        .symbol-btn:active { transform: scale(0.95); background: rgba(59, 130, 246, 0.2); }

        /* Transitions */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .view-section.active {
            display: flex;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 h-screen w-screen overflow-hidden flex flex-col">

    <!-- ================= DASHBOARD VIEW ================= -->
    <div id="dashboardView" class="view-section active flex-col h-full absolute inset-0 z-10 bg-gray-50 dark:bg-gray-900 overflow-y-auto">
        <header class="px-6 py-6 bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-20">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-blue-600 dark:text-blue-400">ProEdit <span class="text-xs align-top text-gray-400">v4</span></h1>
                    <p class="text-xs text-gray-500">Professional Mobile IDE</p>
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i data-lucide="moon" id="dashThemeIcon" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="createNewFilePrompt()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl flex flex-col items-center justify-center font-semibold shadow-lg shadow-blue-500/20 transition-all active:scale-95">
                    <i data-lucide="plus-circle" class="w-6 h-6 mb-1"></i> 
                    <span>New Project</span>
                </button>
                <label class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-white p-4 rounded-xl flex flex-col items-center justify-center font-semibold cursor-pointer transition-all active:scale-95 shadow-sm">
                    <i data-lucide="folder-open" class="w-6 h-6 mb-1 text-yellow-500"></i>
                    <span>Open File</span>
                    <input type="file" id="fileInput" class="hidden" onchange="importFile(this)">
                </label>
            </div>
        </header>

        <main class="flex-1 p-6 pb-20">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Workspace</h2>
                <span id="fileCount" class="text-xs text-gray-400 bg-gray-200 dark:bg-gray-800 px-2 py-1 rounded-full">0 files</span>
            </div>
            
            <div id="fileList" class="grid grid-cols-1 gap-3">
                <!-- File Cards -->
            </div>
            
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-gray-400">
                <i data-lucide="coffee" class="w-12 h-12 mb-3 opacity-30"></i>
                <p class="text-sm">No active projects.</p>
            </div>
        </main>
    </div>

    <!-- ================= EDITOR VIEW ================= -->
    <div id="editorView" class="view-section flex-col h-full absolute inset-0 z-20 bg-white dark:bg-gray-900">
        <!-- Editor Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-2 py-2 flex items-center justify-between shadow-sm shrink-0 z-30">
            <div class="flex items-center min-w-0">
                <button onclick="saveAndGoHome()" class="p-2 mr-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full text-gray-500">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <div class="flex flex-col min-w-0">
                    <input type="text" id="fileNameInput" class="bg-transparent font-bold text-gray-800 dark:text-gray-100 focus:outline-none text-sm w-28 sm:w-40 truncate" value="script.js" onchange="updateCurrentFileName(this.value)">
                </div>
            </div>

            <!-- Toolbar Actions -->
            <div class="flex items-center space-x-1">
                <!-- Undo/Redo (NEW) -->
                <button onclick="editor.undo()" class="p-2 text-gray-500 hover:text-gray-800 dark:hover:text-white" title="Undo">
                    <i data-lucide="undo-2" class="w-4 h-4"></i>
                </button>
                <button onclick="editor.redo()" class="p-2 text-gray-500 hover:text-gray-800 dark:hover:text-white" title="Redo">
                    <i data-lucide="redo-2" class="w-4 h-4"></i>
                </button>

                <!-- Search -->
                <button onclick="toggleSearch()" class="p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                    <i data-lucide="search" class="w-4 h-4"></i>
                </button>

                <!-- Run -->
                <button onclick="runCode()" class="ml-1 px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-xs flex items-center shadow-md active:scale-95 transition-transform">
                    <i data-lucide="play" class="w-3 h-3 mr-1"></i> RUN
                </button>
            </div>
        </header>

        <!-- Advanced Search Panel (NEW) -->
        <div id="searchBar" class="hidden bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-2 animate-in slide-in-from-top duration-200 shrink-0">
            <div class="flex flex-col space-y-2">
                <!-- Find Row -->
                <div class="flex items-center space-x-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="w-3 h-3 absolute left-3 top-2.5 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Find in file..." class="w-full pl-8 pr-2 py-1.5 text-sm rounded-lg border bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="liveSearch()">
                    </div>
                    <div class="flex items-center bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 overflow-hidden">
                        <button onclick="navigateMatch(-1)" class="px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-600 border-r border-gray-300 dark:border-gray-600">
                            <i data-lucide="chevron-up" class="w-4 h-4"></i>
                        </button>
                        <button onclick="navigateMatch(1)" class="px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <!-- Status & Replace Row -->
                <div class="flex items-center justify-between">
                    <span id="searchCount" class="text-xs text-gray-500 font-mono ml-1">No results</span>
                    <button onclick="document.getElementById('replaceRow').classList.toggle('hidden')" class="text-xs text-blue-500 font-medium">Toggle Replace</button>
                </div>
                <!-- Replace Input (Hidden by default) -->
                <div id="replaceRow" class="hidden flex space-x-2 pt-1 border-t border-gray-200 dark:border-gray-700">
                    <input type="text" id="replaceInput" placeholder="Replace with..." class="flex-1 px-3 py-1.5 text-sm rounded-lg border bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-600">
                    <button onclick="replaceCurrent()" class="px-3 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-lg text-xs font-bold">One</button>
                    <button onclick="replaceAll()" class="px-3 py-1 bg-blue-600 text-white rounded-lg text-xs font-bold">All</button>
                </div>
            </div>
        </div>

        <!-- CodeMirror Area -->
        <main class="flex-1 relative overflow-hidden bg-white dark:bg-gray-900">
            <textarea id="codeEditor"></textarea>
        </main>

        <!-- Quick Symbol Toolbar -->
        <div class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-1 shrink-0 z-30">
            <div class="symbol-toolbar flex px-1 py-1" id="symbolToolbar">
                <!-- Symbols injected via JS -->
            </div>
        </div>
    </div>

    <!-- ================= PREVIEW VIEW ================= -->
    <div id="previewView" class="view-section flex-col h-full absolute inset-0 z-40 bg-white dark:bg-gray-900 translate-x-full transition-transform duration-300">
        <div class="bg-gray-900 text-white px-4 py-3 flex items-center justify-between shadow-lg shrink-0">
            <button onclick="closePreview()" class="flex items-center text-gray-300 hover:text-white">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                <span class="font-medium">Edit Code</span>
            </button>
            <div class="flex items-center space-x-3">
                 <span class="text-xs font-mono bg-black/30 px-2 py-1 rounded text-green-400">‚óè Live</span>
                <button onclick="runCode()" class="bg-white/10 p-1.5 rounded hover:bg-white/20">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <div class="flex-1 relative bg-white w-full">
            <iframe id="previewFrame" class="w-full h-full border-none block"></iframe>
        </div>
    </div>

    <script>
        // --- Initialization ---
        lucide.createIcons();
        const symbols = ['<', '>', '{', '}', '(', ')', '[', ']', '=', ';', ':', '"', "'", '!', '$', '&', '/'];
        
        let files = JSON.parse(localStorage.getItem('proedit_files') || '[]');
        let currentFileId = null;
        let editor = null;
        let darkMode = false;

        // Search State
        let searchState = {
            query: '',
            matches: [], // Array of {from, to}
            currentIndex: -1,
            marks: [] // CodeMirror marks
        };

        // Init Editor
        const textarea = document.getElementById('codeEditor');
        editor = CodeMirror.fromTextArea(textarea, {
            mode: 'htmlmixed',
            lineNumbers: true,
            theme: 'neo',
            lineWrapping: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            styleActiveLine: true,
            tabSize: 4,
            indentUnit: 4,
            viewportMargin: Infinity
        });

        // --- SEARCH SYSTEM V2 (The New Feature) ---

        function toggleSearch() {
            const bar = document.getElementById('searchBar');
            bar.classList.toggle('hidden');
            if(!bar.classList.contains('hidden')) {
                document.getElementById('searchInput').focus();
                liveSearch(); // refresh in case cursor moved
            } else {
                clearSearch();
                editor.focus();
            }
        }

        function clearSearch() {
            searchState.marks.forEach(m => m.clear());
            searchState.matches = [];
            searchState.currentIndex = -1;
            searchState.query = '';
            document.getElementById('searchCount').innerText = "No results";
        }

        function liveSearch() {
            const query = document.getElementById('searchInput').value;
            if (query === searchState.query && searchState.matches.length > 0) return; // No change
            
            clearSearch();
            searchState.query = query;
            
            if (!query) return;

            const cursor = editor.getSearchCursor(query);
            while (cursor.findNext()) {
                const from = cursor.from();
                const to = cursor.to();
                searchState.matches.push({ from, to });
                // Mark all matches lightly
                searchState.marks.push(editor.markText(from, to, { className: "cm-search-match" }));
            }

            if (searchState.matches.length > 0) {
                // Find match closest to current cursor to start there
                const docCursor = editor.getCursor();
                // Simple approximation: find first match after cursor
                let nextIdx = searchState.matches.findIndex(m => m.from.line >= docCursor.line && m.from.ch >= docCursor.ch);
                if (nextIdx === -1) nextIdx = 0; // Wrap to start
                
                searchState.currentIndex = nextIdx;
                highlightActiveMatch();
            }
            
            updateSearchUI();
        }

        function navigateMatch(direction) {
            if (searchState.matches.length === 0) return;

            searchState.currentIndex += direction;
            
            // Handle Wrap around
            if (searchState.currentIndex >= searchState.matches.length) searchState.currentIndex = 0;
            if (searchState.currentIndex < 0) searchState.currentIndex = searchState.matches.length - 1;

            highlightActiveMatch();
            updateSearchUI();
        }

        function highlightActiveMatch() {
            // Remove "active" class from all (hacky but effective way without storing complex state)
            // Ideally we re-render marks, but for speed, let's just clear and redraw specific active mark?
            // Actually, we can just add a second mark on top for the active one.
            
            // Clear previous active highlights if any (we'll just clear all and re-add basic marks, then add active)
            // For performance on mobile, let's just use scrollIntoView and Selection
            
            const match = searchState.matches[searchState.currentIndex];
            
            // Scroll and Select
            editor.setSelection(match.from, match.to);
            editor.scrollIntoView({from: match.from, to: match.to}, 50);

            // Re-apply marks to ensure only one is "active" style
            // Note: CodeMirror doesn't easily support changing class of existing mark.
            // So we rely on selection color usually, but let's add a specific 'active' mark.
            
            // Clear OLD active marks (stored in a separate prop if we wanted, but let's keep it simple)
            // Just rely on the Selection color (Blue/Grey) which is standard.
            // BUT user asked for highlight.
            
            // Let's rely on the native selection for the "Active" one, 
            // and the yellow background for the "Others".
        }

        function updateSearchUI() {
            const countEl = document.getElementById('searchCount');
            if (searchState.matches.length === 0) {
                countEl.innerText = "No results";
            } else {
                countEl.innerText = `${searchState.currentIndex + 1} of ${searchState.matches.length}`;
            }
        }

        function replaceCurrent() {
            if (searchState.matches.length === 0) return;
            const replacement = document.getElementById('replaceInput').value;
            editor.replaceSelection(replacement); // Replaces the currently selected (active) match
            liveSearch(); // Re-index everything
        }

        function replaceAll() {
            const query = document.getElementById('searchInput').value;
            const replacement = document.getElementById('replaceInput').value;
            if (!query) return;
            
            // CodeMirror's operation method for atomic update
            editor.operation(() => {
                const cursor = editor.getSearchCursor(query);
                while (cursor.findNext()) {
                    cursor.replace(replacement);
                }
            });
            liveSearch();
        }

        // --- Toolbar & Init Logic (Standard) ---

        const toolbar = document.getElementById('symbolToolbar');
        
        // Add Tab Key
        const tabBtn = document.createElement('button');
        tabBtn.className = 'symbol-btn';
        tabBtn.innerHTML = '<i data-lucide="arrow-right-to-line" class="w-4 h-4"></i>';
        tabBtn.onclick = (e) => { e.preventDefault(); editor.replaceSelection("    "); editor.focus(); };
        toolbar.appendChild(tabBtn);

        symbols.forEach(sym => {
            const btn = document.createElement('button');
            btn.className = 'symbol-btn';
            btn.textContent = sym;
            btn.onclick = (e) => { e.preventDefault(); editor.replaceSelection(sym); editor.focus(); };
            toolbar.appendChild(btn);
        });

        // Auto-save
        editor.on('change', () => {
            if (currentFileId) {
                const fileIndex = files.findIndex(f => f.id === currentFileId);
                if (fileIndex !== -1) {
                    files[fileIndex].content = editor.getValue();
                    files[fileIndex].lastModified = Date.now();
                    saveToStorage();
                }
            }
        });

        // --- Standard Functions ---

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                if(el.id === 'previewView') el.classList.remove('translate-x-0');
                if(el.id === 'previewView') el.classList.add('translate-x-full');
            });
            if (viewId === 'previewView') {
                document.getElementById('editorView').classList.add('active');
                const pv = document.getElementById('previewView');
                pv.classList.add('active');
                requestAnimationFrame(() => {
                    pv.classList.remove('translate-x-full');
                    pv.classList.add('translate-x-0');
                });
            } else {
                document.getElementById(viewId).classList.add('active');
            }
        }

        function saveAndGoHome() {
            saveToStorage();
            renderFileList();
            switchView('dashboardView');
            currentFileId = null;
        }

        function saveToStorage() {
            localStorage.setItem('proedit_files', JSON.stringify(files));
            updateFileCount();
        }

        function createNewFilePrompt() {
            const name = prompt("Filename:", "index.html");
            if (name) {
                const newFile = {
                    id: Date.now().toString(),
                    name: name,
                    content: getTemplate(name),
                    mode: getModeFromExt(name),
                    lastModified: Date.now()
                };
                files.unshift(newFile);
                saveToStorage();
                openFile(newFile.id);
            }
        }

        function getTemplate(filename) {
            if (filename.endsWith('.js')) return `// ${filename}\nconsole.log("Hello from " + "${filename}");`;
            if (filename.endsWith('.css')) return `/* ${filename} */\nbody { background: #f0f0f0; }`;
            if (filename.endsWith('.html')) return `<!DOCTYPE html>\n<html>\n<body>\n  <h1>New Page</h1>\n</body>\n</html>`;
            return '';
        }

        function getModeFromExt(filename) {
            if (filename.endsWith('.js')) return 'javascript';
            if (filename.endsWith('.css')) return 'css';
            return 'htmlmixed';
        }

        function importFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const newFile = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: e.target.result,
                    mode: getModeFromExt(file.name),
                    lastModified: Date.now()
                };
                files.unshift(newFile);
                saveToStorage();
                openFile(newFile.id);
                input.value = '';
            };
            reader.readAsText(file);
        }

        function openFile(id) {
            const file = files.find(f => f.id === id);
            if (!file) return;
            currentFileId = id;
            document.getElementById('fileNameInput').value = file.name;
            editor.setOption('mode', file.mode);
            editor.setValue(file.content);
            editor.clearHistory();
            switchView('editorView');
            setTimeout(() => editor.refresh(), 100);
        }

        function deleteFile(id, e) {
            e.stopPropagation();
            if(confirm("Delete this file?")) {
                files = files.filter(f => f.id !== id);
                saveToStorage();
                renderFileList();
            }
        }

        function updateCurrentFileName(newName) {
            if (currentFileId) {
                const file = files.find(f => f.id === currentFileId);
                file.name = newName;
                file.mode = getModeFromExt(newName);
                editor.setOption('mode', file.mode);
                saveToStorage();
            }
        }

        function updateFileCount() {
            document.getElementById('fileCount').textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
        }

        function renderFileList() {
            const list = document.getElementById('fileList');
            const empty = document.getElementById('emptyState');
            list.innerHTML = '';

            if (files.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                files.forEach(file => {
                    const date = new Date(file.lastModified).toLocaleDateString();
                    let iconName = 'file-code';
                    let color = 'text-blue-500';
                    if(file.name.endsWith('.js')) { iconName = 'file-json'; color = 'text-yellow-500'; }
                    if(file.name.endsWith('.css')) { iconName = 'palette'; color = 'text-pink-500'; }

                    const card = document.createElement('div');
                    card.className = "flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm active:scale-[0.98] transition-transform cursor-pointer";
                    card.onclick = () => openFile(file.id);
                    
                    card.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <i data-lucide="${iconName}" class="w-6 h-6 ${color}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-sm truncate w-40">${file.name}</h3>
                                <p class="text-xs text-gray-400">Modified: ${date}</p>
                            </div>
                        </div>
                        <button onclick="deleteFile('${file.id}', event)" class="p-2 text-gray-300 hover:text-red-500">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    list.appendChild(card);
                });
                lucide.createIcons();
            }
            updateFileCount();
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark');
            editor.setOption('theme', darkMode ? 'material-palenight' : 'neo');
            document.getElementById('dashThemeIcon').setAttribute('data-lucide', darkMode ? 'sun' : 'moon');
            lucide.createIcons();
        }

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleTheme();

        function runCode() {
            const content = editor.getValue();
            const frame = document.getElementById('previewFrame');
            const doc = frame.contentWindow.document;

            switchView('previewView');

            let codeToRun = content;
            if (editor.getOption('mode') === 'javascript') {
                codeToRun = `
                <!DOCTYPE html>
                <html>
                <body style="font-family: monospace; padding: 20px; background: #1e1e1e; color: #fff;">
                    <div style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; color: #888;">CONSOLE OUTPUT</div>
                    <div id="logs"></div>
                    <script>
                        const log = console.log;
                        const output = document.getElementById('logs');
                        console.log = function(...args) {
                            args.forEach(arg => {
                                const d = document.createElement('div');
                                d.textContent = "> " + (typeof arg === 'object' ? JSON.stringify(arg) : arg);
                                d.style.padding = "4px 0";
                                d.style.borderBottom = "1px solid #333";
                                output.appendChild(d);
                            });
                            log.apply(console, args);
                        };
                        try { ${content} } catch(e) { console.log("Error: " + e.message); }
                    <\/script>
                </body>
                </html>`;
            }
            doc.open();
            doc.write(codeToRun);
            doc.close();
        }
        
        function closePreview() {
            document.getElementById('previewView').classList.remove('translate-x-0');
            document.getElementById('previewView').classList.add('translate-x-full');
            setTimeout(() => document.getElementById('previewView').classList.remove('active'), 300);
        }

        renderFileList();
    </script>
</body>
</html>